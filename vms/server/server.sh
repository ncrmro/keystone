#!/usr/bin/env bash
/nix/store/f4qqnikmv21k441nar8a462dndjjq8r0-qemu-9.2.4/bin/qemu-system-x86_64 \
    -name server,process=server \
    -machine q35,smm=off,vmport=off,accel=kvm \
    -global kvm-pit.lost_tick_policy=discard \
    -cpu host,topoext \
    -smp cores=1,threads=2,sockets=1 \
    -m 4G \
    -device virtio-balloon \
    -pidfile server/server.pid \
    -rtc base=utc,clock=host \
    -vga none \
    -device virtio-gpu,xres=1280,yres=800 \
    -display none \
    -spice disable-ticketing=on,port=5930,addr=127.0.0.1 \
    -device virtio-serial-pci \
    -chardev socket,id=agent0,path=server/server-agent.sock,server=on,wait=off \
    -device virtserialport,chardev=agent0,name=org.qemu.guest_agent.0 \
    -chardev spicevmc,id=vdagent0,name=vdagent \
    -device virtserialport,chardev=vdagent0,name=com.redhat.spice.0 \
    -chardev spiceport,id=webdav0,name=org.spice-space.webdav.0 \
    -device virtserialport,chardev=webdav0,name=org.spice-space.webdav.0 \
    -device virtio-rng-pci,rng=rng0 \
    -object rng-random,id=rng0,filename=/dev/urandom \
    -device qemu-xhci,id=spicepass \
    -chardev spicevmc,id=usbredirchardev1,name=usbredir \
    -device usb-redir,chardev=usbredirchardev1,id=usbredirdev1 \
    -chardev spicevmc,id=usbredirchardev2,name=usbredir \
    -device usb-redir,chardev=usbredirchardev2,id=usbredirdev2 \
    -chardev spicevmc,id=usbredirchardev3,name=usbredir \
    -device usb-redir,chardev=usbredirchardev3,id=usbredirdev3 \
    -device pci-ohci,id=smartpass \
    -device usb-ccid \
    -chardev spicevmc,id=ccid,name=smartcard \
    -device ccid-card-passthru,chardev=ccid \
    -device usb-ehci,id=input \
    -device usb-kbd,bus=input.0 \
    -k en-us \
    -device usb-tablet,bus=input.0 \
    -audiodev spice,id=audio0 \
    -device intel-hda \
    -device hda-micro,audiodev=audio0 \
    -device virtio-net,netdev=nic \
    -netdev user,hostname=server,hostfwd=tcp::22220-:22,smb=/home/ncrmro,id=nic \
    -global driver=cfi.pflash01,property=secure,value=on \
    -drive if=pflash,format=raw,unit=0,file=/nix/store/0nfx5pvd23z8dhngdw3n7ggcjb9lyj3k-OVMF-202411-fd/FV/OVMF_CODE.fd,readonly=on \
    -drive if=pflash,format=raw,unit=1,file=server/OVMF_VARS.fd \
    -device virtio-blk-pci,drive=SystemDisk \
    -drive id=SystemDisk,if=none,format=qcow2,file=server/disk.qcow2 \
    -fsdev local,id=fsdev0,path=/home/ncrmro,security_model=mapped-xattr \
    -device virtio-9p-pci,fsdev=fsdev0,mount_tag=Public-ncrmro \
    -monitor unix:server/server-monitor.socket,server,nowait \
    -serial unix:server/server-serial.socket,server,nowait 2>/dev/null
