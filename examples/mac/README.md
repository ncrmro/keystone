# Example: Keystone on Apple Silicon Mac (M1/M2/M3)

This example shows how to configure Keystone for an Apple Silicon Mac using the `operating-system-mac` module.

## Prerequisites

- Apple Silicon Mac (M1/M2/M3 series)
- macOS 12.3 or later
- Admin access
- NixOS installed via [nixos-apple-silicon](https://github.com/tpwrules/nixos-apple-silicon)

## Important Limitations

- **No ZFS**: Only ext4 storage is supported (ZFS is untested on Asahi kernel)
- **No TPM**: No automatic disk unlock - manual password required on every boot
- **No Secure Boot**: Uses Apple's boot chain instead of lanzaboote
- **Manual partitioning**: Must be done before NixOS installation
- **Single disk only**: No RAID or multi-disk configurations

## Example Configuration

### flake.nix

```nix
{
  description = "Keystone on Apple Silicon Mac";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    keystone.url = "github:ncrmro/keystone";
    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    nixos-apple-silicon = {
      url = "github:tpwrules/nixos-apple-silicon";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, keystone, home-manager, nixos-apple-silicon, ... }: {
    nixosConfigurations.macbook = nixpkgs.lib.nixosSystem {
      system = "aarch64-linux";
      modules = [
        home-manager.nixosModules.home-manager
        keystone.nixosModules.operating-system-mac
        keystone.nixosModules.desktop  # Optional: Hyprland desktop
        ./hardware-configuration.nix
        ./configuration.nix
      ];
    };
  };
}
```

### configuration.nix

```nix
{ config, pkgs, ... }:

{
  # Keystone OS configuration
  keystone.os = {
    enable = true;

    # Storage: ext4 with LUKS encryption
    storage = {
      type = "ext4";  # Only ext4 supported (ZFS untested)
      devices = [
        "/dev/disk/by-id/nvme-APPLE_SSD_AP0512R_..."  # Find with: ls -l /dev/disk/by-id/
      ];
      swap.size = "16G";  # Adjust based on RAM
    };

    # Remote unlock (optional - allows SSH into initrd to unlock LUKS)
    remoteUnlock = {
      enable = false;  # Set to true if needed
      authorizedKeys = [
        # "ssh-ed25519 AAAAC3... alice@laptop"
      ];
    };

    # User configuration
    users.alice = {
      fullName = "Alice Smith";
      email = "alice@example.com";
      extraGroups = [ "wheel" "networkmanager" ];
      
      # Set initial password (change after first login)
      initialPassword = "changeme";
      # Or use hashed password: hashedPassword = "$6$...";
      
      # Enable terminal dev environment
      terminal.enable = true;
      
      # Enable desktop environment (optional)
      desktop = {
        enable = true;
        hyprland.modifierKey = "SUPER";
      };
    };

    # System services
    services = {
      avahi.enable = true;      # mDNS for .local hostnames
      firewall.enable = true;   # Basic firewall
      resolved.enable = true;   # DNS resolution
    };

    # SSH server
    ssh.enable = true;
  };

  # System packages
  environment.systemPackages = with pkgs; [
    vim
    wget
    curl
    git
  ];

  # Networking
  networking.hostName = "macbook";
  networking.networkmanager.enable = true;

  # Timezone and locale
  time.timeZone = "America/New_York";
  i18n.defaultLocale = "en_US.UTF-8";

  # Don't change this
  system.stateVersion = "24.11";
}
```

### hardware-configuration.nix

Generated by NixOS installer. Key points:

```nix
{ config, lib, pkgs, modulesPath, ... }:

{
  imports = [ (modulesPath + "/installer/scan/not-detected.nix") ];

  # Boot configuration (managed by keystone)
  boot.initrd.availableKernelModules = [ "nvme" "usb_storage" "sd_mod" ];
  
  # Network module for initrd (if using remote unlock)
  # boot.initrd.availableKernelModules = [ "r8169" ];  # Ethernet
  
  # File systems (managed by disko via keystone)
  fileSystems = {
    "/" = {
      device = "/dev/mapper/crypted";
      fsType = "ext4";
    };
    "/boot" = {
      device = "/dev/disk/by-label/ESP";
      fsType = "vfat";
    };
  };

  # Swap (optional)
  swapDevices = [
    { device = "/dev/disk/by-label/swap"; randomEncryption.enable = true; }
  ];

  nixpkgs.hostPlatform = lib.mkDefault "aarch64-linux";
}
```

## Installation Steps

1. **Partition the disk** (manual step - CRITICAL):
   ```bash
   # WARNING: Backup everything first!
   # Use sgdisk to add partitions (preserves macOS recovery)
   sgdisk /dev/nvme0n1 -n 0:0 -s
   
   # Format partitions
   mkfs.vfat -F 32 -n ESP /dev/nvme0n1p5     # EFI partition
   mkswap -L swap /dev/nvme0n1p6              # Swap (optional)
   
   # Create LUKS container for root
   cryptsetup luksFormat /dev/nvme0n1p7
   cryptsetup open /dev/nvme0n1p7 crypted
   mkfs.ext4 -L nixos /dev/mapper/crypted
   ```

2. **Mount and install**:
   ```bash
   mount /dev/mapper/crypted /mnt
   mkdir /mnt/boot
   mount /dev/nvme0n1p5 /mnt/boot
   
   # Generate hardware config
   nixos-generate-config --root /mnt
   
   # Copy your flake and configuration
   cp -r /path/to/your/flake /mnt/etc/nixos/
   
   # Install
   cd /mnt/etc/nixos
   nixos-install --flake .#macbook
   ```

3. **Reboot and unlock**:
   - System will prompt for LUKS password on every boot
   - No TPM auto-unlock available on Apple Silicon

## Key Differences from X86

| Feature | X86 (operating-system) | Mac (operating-system-mac) |
|---------|------------------------|----------------------------|
| Storage | ZFS or ext4 | ext4 only |
| Encryption | LUKS with TPM auto-unlock | LUKS manual password |
| Secure Boot | Lanzaboote | Apple boot chain |
| TPM | Yes | No |
| RAID | Yes (mirror, raidz) | No (single disk only) |
| Bootloader | systemd-boot via lanzaboote | systemd-boot directly |
| EFI variables | Can modify | Cannot modify |

## Troubleshooting

### GPU Not Working
- Asahi GPU drivers are improving rapidly
- Check [Asahi Linux status](https://asahilinux.org/) for updates
- May need to update nixos-apple-silicon input

### Bluetooth/WiFi Issues
- Ensure `hardware.asahi.peripheralFirmwareDirectory` is set
- Firmware should be in `/boot/asahi`

### Boot Fails After Update
- Apple Silicon uses m1n1 → U-Boot → GRUB/systemd-boot chain
- Check NixOS wiki for Apple Silicon troubleshooting

## References

- [nixos-apple-silicon](https://github.com/tpwrules/nixos-apple-silicon)
- [Asahi Linux](https://asahilinux.org/)
- [Keystone research: hardware-macbook.md](../../specs/research.hardware-macbook.md)
