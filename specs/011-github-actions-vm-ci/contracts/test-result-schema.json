{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/ncrmro/keystone/schemas/test-result.json",
  "title": "TestExecutionResult",
  "description": "Structured output from GitHub Actions VM testing workflow for Copilot agent consumption",
  "type": "object",
  "required": [
    "status",
    "phase",
    "timestamp",
    "duration_seconds",
    "workflow_run_id",
    "commit_sha",
    "results"
  ],
  "properties": {
    "status": {
      "type": "string",
      "enum": ["success", "failure"],
      "description": "Overall test execution status"
    },
    "phase": {
      "type": "string",
      "enum": ["build", "boot", "runtime", "services"],
      "description": "Last successfully completed test phase (or phase where failure occurred)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of test execution"
    },
    "duration_seconds": {
      "type": "integer",
      "minimum": 0,
      "description": "Total test execution duration in seconds"
    },
    "workflow_run_id": {
      "type": "string",
      "pattern": "^[0-9]+$",
      "description": "GitHub Actions workflow run identifier"
    },
    "commit_sha": {
      "type": "string",
      "pattern": "^[a-f0-9]{40}$",
      "description": "Git commit SHA that was tested"
    },
    "error": {
      "type": ["object", "null"],
      "description": "Error details if status is failure",
      "required": ["message", "phase", "logs"],
      "properties": {
        "message": {
          "type": "string",
          "maxLength": 500,
          "description": "Human-readable error summary identifying specific failure"
        },
        "phase": {
          "type": "string",
          "enum": ["build", "boot", "runtime", "services"],
          "description": "Test phase where error occurred"
        },
        "logs": {
          "type": "string",
          "maxLength": 2000,
          "description": "Relevant log excerpt with context (2-5 lines before/after error)"
        }
      },
      "additionalProperties": false
    },
    "results": {
      "type": "object",
      "description": "Per-phase test results",
      "required": ["build"],
      "properties": {
        "build": {
          "type": "object",
          "description": "NixOS build phase result",
          "required": ["success", "duration_seconds", "outputs"],
          "properties": {
            "success": {
              "type": "boolean",
              "description": "Whether build completed successfully"
            },
            "duration_seconds": {
              "type": "integer",
              "minimum": 0,
              "description": "Time spent in build phase"
            },
            "outputs": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Generated output paths (e.g., result/bin/run-*-vm)"
            }
          },
          "additionalProperties": false
        },
        "boot": {
          "type": "object",
          "description": "VM boot phase result (present if build succeeded)",
          "required": ["success", "duration_seconds"],
          "properties": {
            "success": {
              "type": "boolean",
              "description": "Whether VM booted successfully"
            },
            "duration_seconds": {
              "type": "integer",
              "minimum": 0,
              "maximum": 300,
              "description": "Total time spent attempting to boot VM (max 300s per FR-004a)"
            },
            "boot_time_seconds": {
              "type": "integer",
              "minimum": 0,
              "description": "Actual boot time from VM start to ready (present if success=true)"
            }
          },
          "additionalProperties": false
        },
        "services": {
          "type": "object",
          "description": "Service validation result (present if boot succeeded)",
          "required": ["success", "running", "failed"],
          "properties": {
            "success": {
              "type": "boolean",
              "description": "Whether all critical services are running"
            },
            "running": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "List of successfully running service names"
            },
            "failed": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "List of failed service names (empty if success=true)"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false,
  "if": {
    "properties": {
      "status": { "const": "failure" }
    }
  },
  "then": {
    "required": ["status", "phase", "timestamp", "duration_seconds", "workflow_run_id", "commit_sha", "error", "results"]
  }
}
