name: Test Deployment

# Only run when explicitly triggered or when specific files change
# This is a longer-running test (10-15 minutes) that requires full VM deployment
on:
  # Allow manual trigger for testing
  workflow_dispatch:
  # Run on PRs that affect deployment-critical files
  pull_request:
    paths:
      - 'bin/test-deployment'
      - 'bin/virtual-machine'
      - 'bin/build-iso'
      - 'modules/**'
      - 'vms/test-server/**'
      - 'flake.nix'
      - '.github/workflows/test-deployment.yml'

jobs:
  test-vm-deployment:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Give enough time for full deployment test
    
    steps:
      # Check out the repository code
      - uses: actions/checkout@v4
      
      # Check available disk space
      - name: Check disk space
        run: |
          echo "Available disk space before starting:"
          df -h
          echo ""
          echo "Free space in /home:"
          df -h /home
      
      # Install Nix package manager with flakes support
      - uses: cachix/install-nix-action@v22
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      # Set up KVM and libvirt for virtualization
      - name: Set up KVM and libvirt
        run: |
          echo "Installing KVM and libvirt packages..."
          sudo apt-get update
          sudo apt-get install -y \
            qemu-kvm \
            libvirt-daemon-system \
            libvirt-clients \
            virtinst \
            bridge-utils \
            cpu-checker \
            python3-libvirt \
            ovmf
          
          echo "Checking KVM availability..."
          ls -la /dev/kvm
          
          echo "Adding runner to kvm and libvirt groups..."
          sudo usermod -a -G kvm,libvirt $USER
          
          echo "Starting libvirt service..."
          sudo systemctl start libvirtd
          sudo systemctl enable libvirtd
          sudo systemctl status libvirtd --no-pager
          
          # Configure libvirt to allow current user
          echo "Configuring libvirt permissions..."
          sudo chmod 666 /var/run/libvirt/libvirt-sock
          
          echo "Verifying libvirt connection..."
          virsh version
      
      # Configure libvirt networking for test VMs
      - name: Set up libvirt network
        run: |
          echo "Ensuring default storage pool exists..."
          virsh pool-list --all
          
          # Create default pool if it doesn't exist
          if ! virsh pool-info default >/dev/null 2>&1; then
            echo "Creating default storage pool..."
            virsh pool-define-as default dir --target /var/lib/libvirt/images
            virsh pool-build default
            virsh pool-start default
            virsh pool-autostart default
          else
            # Make sure it's started
            virsh pool-start default || true
          fi
          
          echo "Creating keystone-net network for test VMs..."
          
          # Create network configuration
          cat > /tmp/keystone-net.xml << 'EOF'
          <network>
            <name>keystone-net</name>
            <forward mode='nat'/>
            <bridge name='virbr1' stp='on' delay='0'/>
            <ip address='192.168.100.1' netmask='255.255.255.0'>
              <dhcp>
                <range start='192.168.100.2' end='192.168.100.254'/>
                <host mac='52:54:00:12:34:56' name='keystone-test-vm' ip='192.168.100.99'/>
              </dhcp>
            </ip>
          </network>
          EOF
          
          # Define and start the network
          virsh net-define /tmp/keystone-net.xml
          virsh net-start keystone-net
          virsh net-autostart keystone-net
          virsh net-list --all
      
      # Generate SSH keys for CI
      - name: Generate SSH keys
        run: |
          echo "Generating SSH key pair for CI..."
          mkdir -p ~/.ssh
          ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519 -C "github-actions-ci@keystone"
          chmod 600 ~/.ssh/id_ed25519
          chmod 644 ~/.ssh/id_ed25519.pub
          echo "SSH public key:"
          cat ~/.ssh/id_ed25519.pub
      
      # Install uv for running Python scripts with dependencies
      - name: Install uv
        run: |
          echo "Installing uv for Python script execution..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      # Verify uv installation
      - name: Verify uv installation
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv --version
      
      # Run the deployment test
      - name: Run deployment test
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "Starting full deployment test..."
          echo "This will:"
          echo "  1. Build ISO with SSH keys"
          echo "  2. Create and start VM"
          echo "  3. Deploy via nixos-anywhere"
          echo "  4. Verify Secure Boot, ZFS, TPM, etc."
          echo ""
          
          # Run test-deployment with full rebuild and debug mode
          ./bin/test-deployment --rebuild-iso --debug
        timeout-minutes: 25
      
      # Clean up on success or failure
      - name: Clean up test VM
        if: always()
        run: |
          echo "Cleaning up test VM and artifacts..."
          virsh destroy keystone-test-vm || true
          virsh undefine keystone-test-vm --nvram || true
          virsh vol-delete --pool default keystone-test-vm.qcow2 || true
          virsh net-destroy keystone-net || true
          virsh net-undefine keystone-net || true
          echo "Cleanup complete"
