#!/usr/bin/env bash
# Test cluster with microVMs
#
# This script starts the primer microVM, waits for k3s and Headscale,
# then optionally starts worker VMs.
#
# Usage:
#   ./bin/test-cluster-microvm              # Start primer only
#   ./bin/test-cluster-microvm --workers    # Start primer + 3 workers
#   ./bin/test-cluster-microvm --shell      # Start primer and drop into shell
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
TESTS_DIR="$PROJECT_ROOT/tests"
SSH_KEY="$TESTS_DIR/fixtures/test-ssh-key"

# SSH options for key-based auth with fallback
SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"
if [ -f "$SSH_KEY" ]; then
    SSH_OPTS="$SSH_OPTS -i $SSH_KEY"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

cleanup() {
    info "Cleaning up..."
    # Kill any running microvm processes
    pkill -f "microvm-run" 2>/dev/null || true
}
trap cleanup EXIT

# Parse arguments
START_WORKERS=false
SHELL_MODE=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --workers)
            START_WORKERS=true
            shift
            ;;
        --shell)
            SHELL_MODE=true
            shift
            ;;
        *)
            error "Unknown option: $1"
            exit 1
            ;;
    esac
done

cd "$TESTS_DIR"

# Build primer microVM
info "Building cluster-primer microVM..."
nix build .#nixosConfigurations.cluster-primer.config.microvm.declaredRunner -o result-primer

info "Starting primer microVM..."
info "  SSH: ssh $SSH_OPTS -p 22223 root@localhost"
info "  k3s API: https://localhost:16443"
info "  Headscale: http://localhost:18080"
echo ""

if $SHELL_MODE; then
    info "Running in foreground. Press Ctrl+C to stop."
    ./result-primer/bin/microvm-run
else
    # Run in background
    ./result-primer/bin/microvm-run &
    PRIMER_PID=$!

    info "Primer started (PID: $PRIMER_PID)"
    info "Waiting for SSH to be ready..."

    # Wait for SSH
    for i in {1..60}; do
        if ssh $SSH_OPTS -o ConnectTimeout=1 -p 22223 root@localhost exit 2>/dev/null; then
            break
        fi
        sleep 2
    done

    info "Primer is ready!"

    # Check k3s status
    info "Waiting for k3s to be ready..."
    for i in {1..60}; do
        if ssh $SSH_OPTS -p 22223 root@localhost "kubectl get nodes" &>/dev/null; then
            info "k3s is ready!"
            break
        fi
        [ $i -eq 60 ] && { error "Timeout waiting for k3s"; exit 1; }
        sleep 5
    done

    if $START_WORKERS; then
        # Generate pre-auth key from primer
        info "Generating Headscale pre-auth key..."
        AUTH_KEY=$(ssh $SSH_OPTS -p 22223 root@localhost \
            "kubectl exec -n headscale-system deploy/headscale -- headscale preauthkeys create --user default --reusable --expiration 1h" | grep -oE '[a-z0-9]{48}')
        
        if [ -z "$AUTH_KEY" ]; then
            error "Failed to generate auth key"
            exit 1
        fi
        info "Generated auth key: ${AUTH_KEY:0:10}..."

        # Build and start workers
        for i in 1 2 3; do
            info "Building cluster-worker$i microVM..."
            nix build ".#nixosConfigurations.cluster-worker$i.config.microvm.declaredRunner" -o "result-worker$i"

            info "Starting worker$i..."
            "./result-worker$i/bin/microvm-run" &
        done

        info "Waiting for workers to boot and join mesh..."
        # We need to manually trigger tailscale up on workers since we have the key now
        # OR we could have updated the worker config with the key, but runtime join is more realistic
        for i in 1 2 3; do
            PORT=$((22230 + i))
            info "Waiting for worker$i SSH (port $PORT)..."
            for j in {1..60}; do
                if ssh $SSH_OPTS -o ConnectTimeout=1 -p $PORT root@localhost exit 2>/dev/null; then
                    break
                fi
                sleep 2
            done

            info "Joining worker$i to mesh..."
            ssh $SSH_OPTS -p $PORT root@localhost "/etc/keystone/join-mesh.sh $AUTH_KEY"
        done

        info "Verifying mesh connectivity..."
        ssh $SSH_OPTS -p 22223 root@localhost \
            "kubectl exec -n headscale-system deploy/headscale -- headscale nodes list"
    fi

    info ""
    info "Cluster test complete!"
    if [ -t 0 ]; then
        info "Press Enter to stop cluster..."
        read -r
    else
        info "Non-interactive mode: Cluster will run for 30s then exit..."
        sleep 30
    fi
fi
