#!/usr/bin/env bash
# Test the Keystone installer TUI using NixOS VM tests
#
# Usage:
#   ./bin/test-installer             # Run headlessly (default)
#   ./bin/test-installer --interactive  # Watch the test in a graphical window
#   ./bin/test-installer --help      # Show help
#
# This script builds and runs the NixOS VM test for the installer TUI.
# In interactive mode, you can watch the VM and manually interact with it.
#
# Interactive mode REPL commands:
#   >>> start_all()           # Start the VM
#   >>> test_script()         # Run the full test
#   >>> installer.shell_interact()  # Drop into VM shell
#
# For manual stepping:
#   >>> installer.wait_for_text("Network Connected")
#   >>> installer.send_key("ret")
#   >>> installer.send_chars("my-hostname")
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    echo "Usage: ./bin/test-installer [OPTIONS]"
    echo ""
    echo "Test the Keystone installer TUI using NixOS VM tests."
    echo ""
    echo "Options:"
    echo "  --interactive    Run in interactive mode with graphical display"
    echo "  --headless       Run headlessly (default)"
    echo "  --build-only     Only build the test, don't run it"
    echo "  --help           Show this help message"
    echo ""
    echo "Interactive Mode:"
    echo "  In interactive mode, the test driver starts a Python REPL where"
    echo "  you can watch the VM and manually control the test."
    echo ""
    echo "  Common commands:"
    echo "    >>> start_all()                    # Start the VM"
    echo "    >>> test_script()                  # Run the full test"
    echo "    >>> installer.shell_interact()     # Drop into VM shell"
    echo "    >>> installer.wait_for_text('X')   # Wait for text on screen"
    echo "    >>> installer.send_key('ret')      # Send key (ret, down, up, etc)"
    echo "    >>> installer.send_chars('text')   # Type characters"
    echo ""
    echo "Examples:"
    echo "  ./bin/test-installer                 # Run test headlessly"
    echo "  ./bin/test-installer --interactive   # Watch test interactively"
    echo ""
}

MODE="headless"
BUILD_ONLY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --interactive)
            MODE="interactive"
            shift
            ;;
        --headless)
            MODE="headless"
            shift
            ;;
        --build-only)
            BUILD_ONLY=true
            shift
            ;;
        --help)
            show_help
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            show_help
            exit 1
            ;;
    esac
done

cd "$PROJECT_DIR"

if [[ "$MODE" == "interactive" ]]; then
    echo -e "${BLUE}Building interactive test driver...${NC}"
    nix build .#checks.x86_64-linux.installer-test.driverInteractive

    if [[ "$BUILD_ONLY" == "true" ]]; then
        echo -e "${GREEN}Build complete: ./result/bin/nixos-test-driver${NC}"
        exit 0
    fi

    echo -e "${GREEN}Starting interactive test driver...${NC}"
    echo ""
    echo -e "${YELLOW}Interactive mode tips:${NC}"
    echo "  - Type 'start_all()' to start the VM"
    echo "  - Type 'test_script()' to run the full test"
    echo "  - Type 'installer.shell_interact()' for a VM shell"
    echo "  - Use Ctrl+D or 'exit()' to quit"
    echo ""
    ./result/bin/nixos-test-driver --interactive
else
    echo -e "${BLUE}Building and running test headlessly...${NC}"

    if [[ "$BUILD_ONLY" == "true" ]]; then
        nix build .#checks.x86_64-linux.installer-test
        echo -e "${GREEN}Build complete: ./result${NC}"
        exit 0
    fi

    # Run the test
    if nix build .#checks.x86_64-linux.installer-test --print-build-logs; then
        echo -e "${GREEN}✓ All tests passed!${NC}"
        exit 0
    else
        echo -e "${RED}✗ Test failed!${NC}"
        echo "Run with --interactive to debug"
        exit 1
    fi
fi
