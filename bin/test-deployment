#!/usr/bin/env python3
"""
Keystone Deployment Test Script

Automates the complete VM deployment testing workflow:
- VM lifecycle management (start, stop, hard reset)
- ISO building (optional)
- nixos-anywhere deployment
- Post-deployment verification

Zero external dependencies - uses only Python standard library.

Usage:
    ./bin/test-deployment                    # Normal test run
    ./bin/test-deployment --rebuild-iso      # Rebuild ISO first
    ./bin/test-deployment --hard-reset       # Force kill VM and clean artifacts
    ./bin/test-deployment --rebuild-iso --hard-reset  # Full clean test
"""

import subprocess
import sys
import time
import os
import signal
from pathlib import Path

# ANSI color codes
RED = '\033[0;31m'
GREEN = '\033[0;32m'
YELLOW = '\033[1;33m'
BLUE = '\033[0;34m'
CYAN = '\033[0;36m'
NC = '\033[0m'  # No Color

def print_step(step_num, total_steps, message):
    """Print a formatted step message"""
    print(f"\n{BLUE}[{step_num}/{total_steps}]{NC} {message}")

def print_success(message):
    """Print a success message"""
    print(f"{GREEN}✓{NC} {message}")

def print_error(message):
    """Print an error message"""
    print(f"{RED}✗{NC} {message}")

def print_warning(message):
    """Print a warning message"""
    print(f"{YELLOW}⚠{NC} {message}")

def print_info(message):
    """Print an info message"""
    print(f"{CYAN}ℹ{NC} {message}")

def run_command(cmd, check=True, capture=False, timeout=None):
    """Run a shell command"""
    try:
        if capture:
            result = subprocess.run(
                cmd,
                shell=True,
                check=check,
                capture_output=True,
                text=True,
                timeout=timeout
            )
            return result.stdout.strip()
        else:
            result = subprocess.run(cmd, shell=True, check=check, timeout=timeout)
            return result.returncode == 0
    except subprocess.CalledProcessError as e:
        if check:
            raise
        return False
    except subprocess.TimeoutExpired:
        print_error(f"Command timed out after {timeout} seconds")
        return False

def find_vm_processes():
    """Find running quickemu or qemu VM processes for server"""
    try:
        # Match both quickemu processes and direct qemu processes with server name
        output = run_command("pgrep -f '(quickemu.*server|qemu.*-name server)'", check=False, capture=True)
        if output:
            return [int(pid) for pid in output.split('\n') if pid.strip()]
        return []
    except:
        return []

def kill_vm_processes(hard=False):
    """Kill VM processes"""
    pids = find_vm_processes()
    if not pids:
        print_info("No VM processes found")
        return True

    signal_type = signal.SIGKILL if hard else signal.SIGTERM
    signal_name = "SIGKILL" if hard else "SIGTERM"

    for pid in pids:
        try:
            print_info(f"Sending {signal_name} to process {pid}")
            os.kill(pid, signal_type)
            time.sleep(0.5)
        except ProcessLookupError:
            pass  # Already dead
        except PermissionError:
            print_error(f"Permission denied to kill process {pid}")
            return False

    # Wait for processes to die
    for i in range(10):
        remaining = find_vm_processes()
        if not remaining:
            print_success("All VM processes terminated")
            # Extra cooldown to ensure disk is released
            print_info("Waiting for disk to be fully released...")
            time.sleep(3)
            return True
        time.sleep(0.5)

    print_error("Some VM processes still running")
    return False

def clean_vm_artifacts():
    """Remove VM disk and runtime files, and restore ISO line in config"""
    # Sync filesystems to ensure all writes are flushed
    run_command("sync", check=False)
    time.sleep(1)

    # Restore ISO line in config if it was commented out
    config_file = Path("vms/server.conf")
    if config_file.exists():
        config_content = config_file.read_text()
        if '#iso="keystone-installer.iso"' in config_content:
            config_content = config_content.replace('#iso="keystone-installer.iso"', 'iso="keystone-installer.iso"')
            config_file.write_text(config_content)
            print_info("Restored ISO line in VM configuration")

    vm_dir = Path("vms/server")
    if not vm_dir.exists():
        print_info("VM directory doesn't exist, nothing to clean")
        return True

    artifacts = [
        "disk.qcow2",
        "OVMF_VARS.fd",
        "*.pid",
        "*.socket",
        "*.log",
        "*.ports"
    ]

    removed = []
    for pattern in artifacts:
        for file in vm_dir.glob(pattern):
            try:
                file.unlink()
                removed.append(file.name)
            except Exception as e:
                print_warning(f"Could not remove {file}: {e}")

    if removed:
        print_success(f"Removed {len(removed)} artifact(s): {', '.join(removed)}")
    else:
        print_info("No artifacts to clean")

    return True

def rebuild_iso():
    """Rebuild the Keystone ISO with SSH keys"""
    print_info("Building ISO with SSH key injection...")
    print_info("This may take 2-5 minutes...")

    ssh_key_file = Path.home() / ".ssh" / "id_ed25519.pub"
    if not ssh_key_file.exists():
        print_error(f"SSH key not found: {ssh_key_file}")
        return False

    cmd = f"./bin/build-iso --ssh-key {ssh_key_file}"
    success = run_command(cmd, timeout=300)

    if success:
        print_success("ISO built successfully")
        return True
    else:
        print_error("ISO build failed")
        return False

def patch_vm_script_remove_snapshot():
    """Remove snapshot mode from VM script (makes disk read-only)"""
    script_file = Path("vms/server/server.sh")
    if not script_file.exists():
        return False

    content = script_file.read_text()

    # Check if already patched
    if "-snapshot" not in content:
        print_info("VM script already patched (snapshot removed)")
        return True

    # Remove snapshot mode
    patched = content.replace("    -snapshot \\\n", "")

    if patched != content:
        script_file.write_text(patched)
        print_success("Patched VM script: removed snapshot mode")
        return True

    print_info("VM script doesn't need patching")
    return True

def start_vm():
    """Start the VM"""
    print_info("Starting VM from ISO...")

    # Use make to start the VM - it handles disk creation and script generation
    print_info("Starting VM using make vm-server...")
    result = run_command("make vm-server", check=False, timeout=30)

    if not result:
        print_error("Failed to start VM")
        return False

    print_info("Waiting for VM to boot (30 seconds)...")
    time.sleep(30)

    return True

def wait_for_ssh(max_attempts=10, delay=3):
    """Wait for SSH to become available"""
    print_info(f"Waiting for SSH access (max {max_attempts * delay} seconds)...")

    for attempt in range(max_attempts):
        try:
            result = run_command(
                "ssh -p 22220 -o ConnectTimeout=3 -o StrictHostKeyChecking=no root@localhost 'echo ready' 2>/dev/null",
                check=False,
                capture=True,
                timeout=5
            )
            if result == "ready":
                print_success("SSH is ready")
                return True
        except:
            pass

        if attempt < max_attempts - 1:
            print(f"  Attempt {attempt + 1}/{max_attempts}...", end='\r')
            time.sleep(delay)

    print_error("SSH never became available")
    return False

def deploy_to_vm():
    """Deploy using nixos-anywhere with manual cleanup and reboot"""
    print_info("Starting nixos-anywhere deployment...")
    print_info("This will take 5-10 minutes...")
    print_warning("You may need to interact with the deployment (confirmations, etc.)")

    # Use --no-reboot to allow manual cleanup before rebooting
    cmd = "nix run nixpkgs#nixos-anywhere -- --flake .#test-server root@localhost --ssh-port 22220 --no-reboot"
    success = run_command(cmd, timeout=600)

    if not success:
        print_error("Deployment failed")
        return False

    print_success("Deployment phase completed!")

    # Now perform manual cleanup to prevent hanging during pool export
    print_info("Performing cleanup before reboot...")

    cleanup_cmd = """ssh -p 22220 -o StrictHostKeyChecking=no root@localhost '
        # Unmount all ZFS filesystems first
        if zpool list rpool >/dev/null 2>&1; then
            echo "Unmounting ZFS filesystems..."
            # Change to root to ensure we are not in /mnt
            cd /
            # Unmount all filesystems under /mnt
            umount -R /mnt 2>/dev/null || true
        fi

        # Close the credstore LUKS device (must be done before pool export)
        if cryptsetup status credstore >/dev/null 2>&1; then
            echo "Closing credstore LUKS device..."
            cryptsetup close credstore
        fi

        # Now safely export the ZFS pool
        if zpool list rpool >/dev/null 2>&1; then
            echo "Exporting ZFS pool..."
            zpool export rpool
        fi

        # Trigger reboot
        echo "Rebooting system..."
        nohup sh -c "sleep 2 && reboot" >/dev/null 2>&1 &
    '"""

    cleanup_success = run_command(cleanup_cmd, check=False, timeout=30)

    if cleanup_success:
        print_success("Cleanup and reboot triggered successfully!")
    else:
        print_warning("Cleanup command had issues, but system may still reboot")

    # Manual password entry step
    print()
    print("=" * 60)
    print_warning("MANUAL STEP REQUIRED: Password Entry")
    print("=" * 60)
    print()
    print("The deployed system is rebooting and will prompt for a password.")
    print()
    print("WHAT TO DO:")
    print("1. The password prompt will appear in THIS TERMINAL (no separate window)")
    print("2. Wait for the boot password prompt to appear below")
    print("3. Enter a password to unlock the credstore when prompted")
    print("   (You can use any password - this is ephemeral test data)")
    print("4. The system will continue booting after unlock")
    print()
    print_info("The password prompt looks like: 'Please enter passphrase for disk ...'")
    print()

    try:
        input(f"{CYAN}Press Enter once you've entered the password and see the system booting...{NC} ")
    except EOFError:
        # Handle non-interactive environments
        print_warning("Non-interactive mode detected, continuing without confirmation")

    return True

def remove_iso_and_reboot():
    """Remove ISO from VM config and restart to boot from disk"""
    print_info("Exporting ZFS pool before VM restart...")

    # Export the pool cleanly to avoid import conflicts
    export_cmd = """ssh -p 22220 -o StrictHostKeyChecking=no root@localhost '
        if zpool list rpool >/dev/null 2>&1; then
            echo "Exporting ZFS pool rpool..."
            zpool export rpool
            echo "Pool exported successfully"
        else
            echo "Pool not imported, nothing to export"
        fi
    ' 2>/dev/null"""

    export_result = run_command(export_cmd, check=False, timeout=10)
    if export_result:
        print_success("ZFS pool exported successfully")
    else:
        print_warning("Could not export pool (may not be mounted)")

    print_info("Removing ISO from VM configuration...")

    config_file = Path("vms/server.conf")
    if not config_file.exists():
        print_error("VM config file not found")
        return False

    # Read current config
    config_content = config_file.read_text()

    # Comment out the ISO line
    new_config = config_content.replace('iso="keystone-installer.iso"', '#iso="keystone-installer.iso"')

    # Write back
    config_file.write_text(new_config)
    print_success("ISO removed from configuration")

    # Kill VM
    print_info("Stopping VM...")
    if not kill_vm_processes(hard=True):
        print_warning("Failed to stop VM cleanly")

    # Remove generated script so it regenerates without ISO
    script_file = Path("vms/server/server.sh")
    if script_file.exists():
        script_file.unlink()
        print_success("Removed old startup script")

    # Restart VM - use make which handles everything
    print_info("Restarting VM to boot from installed disk...")
    run_command("make vm-server", check=False, timeout=30)

    print_info("Waiting for VM to boot (20 seconds)...")
    time.sleep(20)

    return True

def verify_deployment():
    """Run the verification script"""
    print_info("Waiting for deployed system to finish booting (30 seconds)...")
    time.sleep(30)

    print_info("Running verification checks...")

    # The verification script expects standard SSH port, so we'll do manual checks
    checks = [
        ("SSH connectivity", "ssh -p 22220 -o ConnectTimeout=5 -o StrictHostKeyChecking=no root@localhost 'echo ok' 2>/dev/null"),
        ("Hostname", "ssh -p 22220 -o StrictHostKeyChecking=no root@localhost 'hostname' 2>/dev/null"),
        ("ZFS pool", "ssh -p 22220 -o StrictHostKeyChecking=no root@localhost 'zpool status rpool' 2>/dev/null | grep -q ONLINE"),
        ("SSH service", "ssh -p 22220 -o StrictHostKeyChecking=no root@localhost 'systemctl is-active sshd' 2>/dev/null"),
    ]

    passed = 0
    failed = 0

    for check_name, check_cmd in checks:
        result = run_command(check_cmd, check=False)
        if result:
            print_success(f"{check_name}")
            passed += 1
        else:
            print_error(f"{check_name}")
            failed += 1

    print(f"\nPassed: {GREEN}{passed}{NC}, Failed: {RED}{failed}{NC}")

    return failed == 0

def main():
    """Main test workflow"""
    # Parse arguments
    rebuild_iso_flag = "--rebuild-iso" in sys.argv
    hard_reset_flag = "--hard-reset" in sys.argv
    help_flag = "--help" in sys.argv or "-h" in sys.argv

    if help_flag:
        print(__doc__)
        return 0

    print("=" * 60)
    print(f"{CYAN}Keystone Deployment Test{NC}")
    print("=" * 60)
    print(f"Rebuild ISO: {rebuild_iso_flag}")
    print(f"Hard Reset: {hard_reset_flag}")
    print()

    total_steps = 6  # Updated from 5 to include ISO removal step
    if rebuild_iso_flag:
        total_steps += 1
    if hard_reset_flag:
        total_steps += 2

    current_step = 0

    # Step: Hard reset if requested
    if hard_reset_flag:
        current_step += 1
        print_step(current_step, total_steps, "Hard resetting VM")

        if not kill_vm_processes(hard=True):
            print_error("Failed to kill VM processes")
            return 1

        current_step += 1
        print_step(current_step, total_steps, "Cleaning VM artifacts")

        if not clean_vm_artifacts():
            print_error("Failed to clean VM artifacts")
            return 1
    else:
        # Graceful stop
        current_step += 1
        print_step(current_step, total_steps, "Stopping existing VM")

        if not kill_vm_processes(hard=False):
            print_warning("Failed graceful stop, trying hard kill...")
            kill_vm_processes(hard=True)

    # Step: Rebuild ISO if requested
    if rebuild_iso_flag:
        current_step += 1
        print_step(current_step, total_steps, "Rebuilding ISO")

        if not rebuild_iso():
            return 1

    # Step: Start VM
    current_step += 1
    print_step(current_step, total_steps, "Starting VM from ISO")

    if not start_vm():
        return 1

    # Step: Wait for SSH
    current_step += 1
    print_step(current_step, total_steps, "Waiting for SSH access")

    if not wait_for_ssh():
        print_error("VM did not become accessible")
        return 1

    # Step: Deploy
    current_step += 1
    print_step(current_step, total_steps, "Deploying with nixos-anywhere")

    if not deploy_to_vm():
        print_error("Deployment failed - check output above")
        return 1

    # Step: Remove ISO and reboot to installed system
    current_step += 1
    print_step(current_step, total_steps, "Removing ISO and rebooting to disk")

    if not remove_iso_and_reboot():
        print_error("Failed to remove ISO and reboot")
        return 1

    # Step: Verify
    current_step += 1
    print_step(current_step, total_steps, "Verifying deployment")

    if not verify_deployment():
        print_warning("Some verification checks failed")
        print_info("You can still SSH to the VM: ssh -p 22220 root@localhost")
    else:
        print()
        print("=" * 60)
        print(f"{GREEN}✓ All tests passed!{NC}")
        print("=" * 60)
        print()
        print("SSH to deployed server:")
        print(f"  ssh -p 22220 root@localhost")
        print()

    return 0

if __name__ == "__main__":
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        print()
        print_warning("Test interrupted by user")
        sys.exit(130)
    except Exception as e:
        print_error(f"Unexpected error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
