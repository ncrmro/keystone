#!/usr/bin/env bash
#
# confined-vm - Build and run confined VMs for sandboxed development
#
# This script creates isolated development environments without internet access,
# designed for AI assistants like Claude to work on code in a secure sandbox.
#
# Usage:
#   ./bin/confined-vm [workspace-path] [options]
#
# The VM:
#   - No network access (completely isolated)
#   - Mounts workspace from host via 9P/virtfs
#   - Includes complete development environment
#   - Uses nixos-rebuild build-vm for fast iteration
#
# Features:
#   - Network isolation: No internet access whatsoever
#   - Workspace mounting: Host directory accessible at /mnt/workspace
#   - Development tools: All necessary tools pre-installed
#   - Fast builds: Shares host Nix store via 9P
#

set -euo pipefail

# ANSI colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

print_usage() {
    cat <<EOF
Usage: $0 [WORKSPACE] [OPTIONS]

Build and run a confined VM for sandboxed development.

Arguments:
  WORKSPACE    Path to workspace directory to mount in VM
               (default: current directory)

Options:
  --build-only       Build VM but don't run it
  --clean            Remove old VM artifacts before building
  --config NAME      Use alternative configuration (default: confined-dev)
  --memory SIZE      RAM in MB (default: 4096)
  --cores N          CPU cores (default: 4)
  --help             Show this help message

Examples:
  $0                           # Use current directory as workspace
  $0 /path/to/project          # Mount specific directory
  $0 --clean                   # Clean rebuild
  $0 --memory 8192 --cores 8   # More resources

VM Details:
  - User: dev / Password: dev
  - Root: root / Password: root
  - Workspace mounted at: /mnt/workspace
  - Network: DISABLED (no internet access)
  - Nix store: Shared from host (read-only)

Inside the VM:
  cd /mnt/workspace    # Your project files
  git status           # Git works normally
  nix build            # Build with Nix (offline only)
  cargo build          # Rust development
  npm install          # Node.js development
  # ... any development work ...

Network Isolation:
  - No network interfaces (except loopback)
  - Cannot access internet
  - Cannot make outbound connections
  - Nix builds must use pre-cached dependencies

Pre-caching Dependencies:
  Build on host first to populate Nix store:
    nix build .#yourproject
    nix develop .#yourshell --command true

  Then start VM - it will use host's /nix/store
EOF
}

print_step() {
    echo -e "${BLUE}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
    echo -e "${CYAN}ℹ${NC} $1"
}

# Parse arguments
WORKSPACE="${PWD}"
BUILD_ONLY=false
CLEAN=false
CONFIG="confined-dev"
MEMORY=""
CORES=""

while [ $# -gt 0 ]; do
    case "$1" in
        --help|-h)
            print_usage
            exit 0
            ;;
        --build-only)
            BUILD_ONLY=true
            shift
            ;;
        --clean)
            CLEAN=true
            shift
            ;;
        --config)
            CONFIG="$2"
            shift 2
            ;;
        --memory)
            MEMORY="$2"
            shift 2
            ;;
        --cores)
            CORES="$2"
            shift 2
            ;;
        --*)
            print_error "Unknown option: $1"
            echo
            print_usage
            exit 1
            ;;
        *)
            # First positional argument is workspace
            WORKSPACE="$1"
            shift
            ;;
    esac
done

# Validate workspace path
if [ ! -d "$WORKSPACE" ]; then
    print_error "Workspace directory does not exist: $WORKSPACE"
    exit 1
fi

# Convert to absolute path
WORKSPACE="$(realpath "$WORKSPACE")"

# VM filenames
VM_HOSTNAME="keystone-${CONFIG}"
DISK_IMAGE="${VM_HOSTNAME}.qcow2"
VM_SCRIPT="./result/bin/run-${VM_HOSTNAME}-vm"

# Clean if requested
if [ "$CLEAN" = true ]; then
    print_step "Cleaning old VM artifacts"

    if [ -f "$DISK_IMAGE" ]; then
        rm -f "$DISK_IMAGE"
        print_success "Removed $DISK_IMAGE"
    fi

    if [ -L result ]; then
        rm -f result
        print_success "Removed result symlink"
    fi
fi

# Build VM
print_step "Building confined VM: $CONFIG"
print_info "This may take a few minutes on first build..."

# Build with overrides if specified
NIX_ARGS=()
if [ -n "$MEMORY" ]; then
    NIX_ARGS+=("--override-input" "virtualisation.memorySize" "$MEMORY")
fi
if [ -n "$CORES" ]; then
    NIX_ARGS+=("--override-input" "virtualisation.cores" "$CORES")
fi

if nixos-rebuild build-vm --flake ".#$CONFIG" "${NIX_ARGS[@]}"; then
    print_success "VM built successfully"
else
    print_error "Failed to build VM"
    exit 1
fi

# Verify VM script exists
if [ ! -f "$VM_SCRIPT" ]; then
    print_error "VM script not found: $VM_SCRIPT"
    exit 1
fi

# Show build information
echo
print_info "Configuration: $CONFIG"
print_info "VM script:     $VM_SCRIPT"
print_info "Disk image:    $DISK_IMAGE"
print_info "Workspace:     $WORKSPACE"
echo

# Patch VM script to include workspace mount
# The VM script needs to be modified to add -virtfs for workspace
print_step "Configuring workspace mount"

# Create a wrapper script that adds the workspace mount
WRAPPER_SCRIPT="./run-${CONFIG}-wrapper.sh"
cat > "$WRAPPER_SCRIPT" <<EOF
#!/usr/bin/env bash
# Auto-generated wrapper for confined VM with workspace mount

# Workspace configuration
WORKSPACE_PATH="$WORKSPACE"

# Run the VM with workspace mounted
# We add -virtfs to mount the workspace directory
exec "$VM_SCRIPT" \\
  -virtfs local,path="\$WORKSPACE_PATH",mount_tag=workspace,security_model=none,id=workspace
EOF

chmod +x "$WRAPPER_SCRIPT"
print_success "Workspace mount configured: $WORKSPACE"

# If build-only, exit here
if [ "$BUILD_ONLY" = true ]; then
    print_info "Build complete. To run manually:"
    echo "  $WRAPPER_SCRIPT"
    echo
    print_info "Workspace will be mounted at /mnt/workspace"
    exit 0
fi

# Run the VM
echo
print_step "Starting confined VM..."
print_warning "VM has NO NETWORK ACCESS"
print_info "Login: dev / dev"
print_info "Workspace mounted at: /mnt/workspace"
print_info "Press Ctrl-C or run 'poweroff' to stop VM"
echo

# Verify network isolation before starting
print_info "Network isolation: Enabled"
print_info "  - No network interfaces (except lo)"
print_info "  - No internet access"
print_info "  - Nix builds require pre-cached dependencies"
echo

# Run the VM
exec "$WRAPPER_SCRIPT"
