#!/usr/bin/env python3
"""
Keystone Desktop Testing Script

Tests the Hyprland desktop environment by applying desktop configuration
on top of an existing system deployed by bin/test-deployment.

Prerequisites:
    - VM must already be deployed with bin/test-deployment
    - VM must be running and SSH accessible at 192.168.100.99

Workflow:
    1. Verify VM is accessible
    2. Check if desktop already installed (via /var/lib/keystone-desktop-installed marker)
    3. Apply desktop configuration (.#test-hyprland) via nixos-rebuild
    4. Create installation marker file (contents: "1")
    5. Reboot VM on first-time installation (required for greetd to start)
    6. Verify desktop services are running after reboot
    7. Test graphical session components

First-Time Installation:
    - The script detects first-time installation by checking for the marker file
    - After successful deployment, creates /var/lib/keystone-desktop-installed with contents "1"
    - Automatically reboots the VM to start greetd display manager
    - Waits for VM to come back online before verification

Subsequent Runs:
    - Skips reboot if marker file exists
    - Updates configuration without restarting display manager

Usage:
    ./bin/test-desktop                    # Normal desktop test
    ./bin/test-desktop --debug            # Show detailed output
    ./bin/test-desktop --verify-only      # Only verify, don't rebuild

See: specs/009-hyprland-desktop/quickstart.md for manual testing steps
"""

import subprocess
import sys
import time
import os
from pathlib import Path

# ANSI color codes
RED = '\033[0;31m'
GREEN = '\033[0;32m'
YELLOW = '\033[1;33m'
BLUE = '\033[0;34m'
CYAN = '\033[0;36m'
NC = '\033[0m'  # No Color

VM_IP = "192.168.100.99"
VM_HOSTNAME = "keystone-test-vm"
DESKTOP_MARKER_FILE = "/var/lib/keystone-desktop-installed"

def print_step(step_num, total_steps, message):
    """Print a formatted step message"""
    print(f"\n{BLUE}[{step_num}/{total_steps}]{NC} {message}")

def print_success(message):
    """Print a success message"""
    print(f"{GREEN}✓{NC} {message}")

def print_error(message):
    """Print an error message"""
    print(f"{RED}✗{NC} {message}")

def print_warning(message):
    """Print a warning message"""
    print(f"{YELLOW}⚠{NC} {message}")

def print_info(message):
    """Print an info message"""
    print(f"{CYAN}ℹ{NC} {message}")

def run_command(cmd, check=True, capture=False, timeout=None):
    """Run a shell command"""
    try:
        if capture:
            result = subprocess.run(
                cmd,
                shell=True,
                check=check,
                capture_output=True,
                text=True,
                timeout=timeout
            )
            return result.stdout.strip()
        else:
            result = subprocess.run(cmd, shell=True, check=check, timeout=timeout)
            return result.returncode == 0
    except subprocess.CalledProcessError as e:
        if check:
            raise
        return False
    except subprocess.TimeoutExpired:
        print_error(f"Command timed out after {timeout} seconds")
        return False

def ssh_vm(command, check=True, capture=False, timeout=None):
    """Execute SSH command on the test VM"""
    ssh_cmd = f"ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@{VM_IP} '{command}'"
    return run_command(ssh_cmd, check=check, capture=capture, timeout=timeout)

def verify_vm_accessible():
    """Verify VM is running and SSH accessible"""
    print_info(f"Checking if VM is accessible at {VM_IP}...")

    try:
        result = ssh_vm("echo ready", check=False, capture=True, timeout=5)
        if result == "ready":
            print_success("VM is accessible via SSH")
            return True
    except:
        pass

    print_error("VM is not accessible")
    print_info("Please run bin/test-deployment first to set up the base system")
    return False

def get_hostname():
    """Get the hostname from the VM"""
    try:
        return ssh_vm("hostname", check=False, capture=True, timeout=5)
    except:
        return None

def cleanup_vm_host_key():
    """Remove VM host key from known_hosts to allow for host key changes during testing"""
    print_info(f"Cleaning up old host key for {VM_IP}...")
    # Use 2>&1 to suppress both stdout and stderr
    result = run_command(f"ssh-keygen -R {VM_IP} >/dev/null 2>&1", check=False)
    # Always return True since this is a best-effort cleanup
    # (it's OK if the key doesn't exist)
    print_success("Host key cleanup complete")
    return True

def is_desktop_installed():
    """Check if desktop has been previously installed by checking marker file"""
    result = ssh_vm(f"test -f {DESKTOP_MARKER_FILE} && cat {DESKTOP_MARKER_FILE}", check=False, capture=True, timeout=5)
    return result == "1"

def create_desktop_marker():
    """Create marker file to indicate desktop has been installed"""
    print_info("Creating desktop installation marker...")
    result = ssh_vm(f"echo '1' | tee {DESKTOP_MARKER_FILE}", check=False, capture=True, timeout=5)
    if result == "1":
        print_success(f"Desktop marker created at {DESKTOP_MARKER_FILE}")
        return True
    else:
        print_error("Failed to create desktop marker")
        return False

def reboot_vm():
    """Reboot the VM and wait for it to come back online"""
    print_info("Rebooting VM to start display manager...")

    # Send reboot command (don't wait for response as connection will drop)
    ssh_vm("reboot", check=False, timeout=5)

    print_info("Waiting for VM to shut down...")
    time.sleep(10)

    print_info("Waiting for VM to come back online...")
    max_wait = 120  # 2 minutes
    start_time = time.time()

    while time.time() - start_time < max_wait:
        try:
            result = ssh_vm("echo ready", check=False, capture=True, timeout=5)
            if result == "ready":
                elapsed = int(time.time() - start_time)
                print_success(f"VM is back online (took {elapsed} seconds)")
                return True
        except:
            pass

        time.sleep(5)

    print_error("VM did not come back online within 2 minutes")
    return False

def apply_desktop_config(debug=False):
    """Apply desktop configuration via nixos-rebuild on the VM"""
    print_info("Applying desktop configuration to VM...")
    print_info("This will reconfigure the system to include Hyprland desktop")
    print_info("This may take 5-10 minutes...")

    if debug:
        print_warning("Debug mode: showing full nixos-rebuild output")
    else:
        print_info("Running in quiet mode. Use --debug to see full output")

    # Build the desktop configuration locally first
    print_info("Building desktop configuration locally...")
    build_cmd = "nix build .#nixosConfigurations.test-hyprland.config.system.build.toplevel"

    if debug:
        success = run_command(build_cmd, timeout=600)
    else:
        success = run_command(f"{build_cmd} 2>&1 | grep -E '(error|warning)' || true", check=False, timeout=600)

    if not success:
        print_error("Failed to build desktop configuration locally")
        return False

    print_success("Desktop configuration built successfully")

    # Copy the closure to the VM and switch
    print_info("Deploying configuration to VM...")

    # Use nixos-rebuild with --target-host to build locally and deploy to VM
    # Set NIX_SSHOPTS to bypass host key checking (required for VM testing)
    ssh_opts = "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
    rebuild_cmd = f"nixos-rebuild switch --flake .#test-hyprland --target-host root@{VM_IP}"

    # Set up environment with SSH options
    import os
    env = os.environ.copy()
    env["NIX_SSHOPTS"] = ssh_opts

    if debug:
        result = subprocess.run(rebuild_cmd, shell=True, env=env, timeout=900)
        success = result.returncode == 0
    else:
        try:
            result = subprocess.run(
                rebuild_cmd,
                shell=True,
                capture_output=True,
                text=True,
                env=env,
                timeout=900
            )
            success = result.returncode == 0
            if not success:
                print_error("Desktop configuration deployment failed! Output:")
                print(result.stderr)
        except subprocess.TimeoutExpired:
            print_error("Deployment timed out after 15 minutes")
            return False

    if success:
        print_success("Desktop configuration applied successfully")
        return True
    else:
        print_error("Failed to apply desktop configuration")
        return False

def verify_desktop_services():
    """Verify essential desktop services are running"""
    print_info("Verifying desktop services...")

    checks = [
        ("greetd", "systemctl is-active greetd.service"),
        ("Hyprland package", "which Hyprland"),
        ("chromium package", "which chromium"),
    ]

    all_passed = True
    for name, cmd in checks:
        result = ssh_vm(cmd, check=False, capture=True, timeout=10)
        if result and result != "inactive":
            print_success(f"{name}: OK")
        else:
            print_error(f"{name}: FAILED")
            all_passed = False

    return all_passed

def verify_desktop_packages():
    """Verify desktop packages are installed"""
    print_info("Verifying desktop packages...")

    packages = [
        "chromium",
        "hyprlock",
        "hypridle",
        "ghostty",
        "waybar",
        "mako",
        "hyprpaper",
    ]

    all_installed = True
    for pkg in packages:
        result = ssh_vm(f"which {pkg}", check=False, capture=True, timeout=5)
        if result:
            print_success(f"  {pkg}: installed")
        else:
            print_error(f"  {pkg}: NOT FOUND")
            all_installed = False

    return all_installed

def verify_home_manager_config():
    """Verify home-manager configuration for test user"""
    print_info("Verifying home-manager configuration for testuser...")

    # Check if testuser exists
    result = ssh_vm("id testuser", check=False, capture=True, timeout=5)
    if not result or "no such user" in result.lower():
        print_error("testuser does not exist")
        return False

    print_success("testuser exists")

    # Check if home-manager profile exists
    result = ssh_vm("test -d /nix/var/nix/profiles/per-user/testuser/home-manager && echo 'exists'", check=False, capture=True, timeout=5)
    if result == "exists":
        print_success("home-manager profile exists for testuser")
        return True
    else:
        print_warning("home-manager profile may not be activated yet")
        return True  # Not a hard failure

def print_manual_test_steps():
    """Print manual testing steps for graphical session"""
    print(f"\n{CYAN}{'='*60}{NC}")
    print(f"{CYAN}Manual Testing Steps:{NC}")
    print(f"{CYAN}{'='*60}{NC}")
    print()
    print("1. Connect to VM graphical console:")
    print(f"   {YELLOW}remote-viewer $(virsh domdisplay keystone-test-vm){NC}")
    print()
    print("2. You should see greetd login prompt")
    print(f"   Login as: {YELLOW}testuser{NC}")
    print(f"   Password: {YELLOW}testpass{NC}")
    print()
    print("3. After login, verify:")
    print("   - Waybar appears at top of screen")
    print("   - Hyprpaper shows wallpaper")
    print("   - Press Super+Enter to open ghostty terminal")
    print("   - Test notification: notify-send 'Test' 'Hello'")
    print()
    print("4. Test screen lock:")
    print("   - Wait 5 minutes for hypridle to trigger hyprlock")
    print("   - Or manually: hyprlock")
    print()
    print(f"{CYAN}{'='*60}{NC}\n")

def main():
    """Main test execution"""
    # Parse arguments
    debug = "--debug" in sys.argv
    verify_only = "--verify-only" in sys.argv

    print(f"\n{BLUE}{'='*60}{NC}")
    print(f"{BLUE}Keystone Desktop Testing{NC}")
    print(f"{BLUE}{'='*60}{NC}\n")

    if verify_only:
        total_steps = 4
    else:
        total_steps = 9  # Increased for new steps: check marker, create marker, reboot

    current_step = 0

    # Step: Verify VM is accessible
    current_step += 1
    print_step(current_step, total_steps, "Verifying VM is accessible")

    if not verify_vm_accessible():
        print_error("VM is not accessible. Please run bin/test-deployment first.")
        return 1

    # Show current hostname
    hostname = get_hostname()
    if hostname:
        print_info(f"Current hostname: {hostname}")

    # Check if desktop already installed
    first_time_install = False
    if not verify_only:
        current_step += 1
        print_step(current_step, total_steps, "Checking desktop installation status")

        if is_desktop_installed():
            print_success("Desktop already installed (found marker file)")
            first_time_install = False
        else:
            print_info("First-time desktop installation detected")
            print_warning("VM will be rebooted after installation to start display manager")
            first_time_install = True

    if not verify_only:
        # Step: Clean up SSH host key
        current_step += 1
        print_step(current_step, total_steps, "Cleaning up SSH host key")

        if not cleanup_vm_host_key():
            print_warning("Failed to cleanup host key, continuing anyway...")

        # Step: Apply desktop configuration
        current_step += 1
        print_step(current_step, total_steps, "Applying desktop configuration")

        if not apply_desktop_config(debug=debug):
            print_error("Failed to apply desktop configuration")
            return 1

        # Step: Create desktop marker
        current_step += 1
        print_step(current_step, total_steps, "Creating desktop installation marker")

        if not create_desktop_marker():
            print_warning("Failed to create marker file, continuing anyway...")

        # Step: Reboot if first time
        if first_time_install:
            current_step += 1
            print_step(current_step, total_steps, "Rebooting VM (first-time installation)")

            if not reboot_vm():
                print_error("Failed to reboot VM or VM did not come back online")
                return 1

            # Clean up host key again after reboot (it may have changed)
            print_info("Cleaning up SSH host key after reboot...")
            cleanup_vm_host_key()

            # Wait for services to stabilize after reboot
            print_info("Waiting for services to stabilize after reboot...")
            time.sleep(15)
        else:
            # Skip reboot step for display purposes
            current_step += 1
            print_step(current_step, total_steps, "Skipping reboot (desktop already installed)")
            print_info("Desktop was previously installed, no reboot required")

            # Wait for services to stabilize after config change
            print_info("Waiting for services to stabilize...")
            time.sleep(10)

    # Step: Verify desktop services
    current_step += 1
    print_step(current_step, total_steps, "Verifying desktop services")

    if not verify_desktop_services():
        print_warning("Some desktop services are not running correctly")

    # Step: Verify desktop packages
    current_step += 1
    print_step(current_step, total_steps, "Verifying desktop packages")

    if not verify_desktop_packages():
        print_warning("Some desktop packages are missing")

    # Step: Verify home-manager configuration
    current_step += 1
    print_step(current_step, total_steps, "Verifying home-manager configuration")

    if not verify_home_manager_config():
        print_warning("home-manager configuration may need attention")

    # Step: Print manual test instructions
    current_step += 1
    print_step(current_step, total_steps, "Manual testing steps")

    print_manual_test_steps()

    print(f"\n{GREEN}{'='*60}{NC}")
    print(f"{GREEN}Desktop Configuration Applied Successfully!{NC}")
    print(f"{GREEN}{'='*60}{NC}\n")

    print_info("Next steps:")
    print("  1. Follow the manual testing steps above")
    print("  2. Review specs/009-hyprland-desktop/quickstart.md for detailed verification")
    print(f"  3. SSH to VM: ssh root@{VM_IP}")
    print()

    return 0

if __name__ == "__main__":
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        print(f"\n{YELLOW}Test interrupted by user{NC}")
        sys.exit(130)
    except Exception as e:
        print_error(f"Unexpected error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
