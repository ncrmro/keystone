#!/usr/bin/env bash
# =============================================================================
# test-microvm-agent - Test Agent Sandbox MicroVM
# =============================================================================
#
# PURPOSE:
#   Validates the agent sandbox guest environment in a lightweight microvm.
#   This is Tier 1 testing for the agent sandbox, providing fast iteration
#   (~20s) on guest configuration without full QEMU/libvirt overhead.
#
# FUNCTIONAL REQUIREMENTS TESTED:
#   - FR-001: Isolated execution environment (MicroVM)
#   - FR-003: AI agents pre-installed and configured
#   - FR-004: Multiple worktrees support
#   See: specs/012-agent-sandbox/spec.md
#
# WHAT THIS TEST VALIDATES:
#   - Guest OS boots successfully
#   - Development tools are installed (git, direnv, jq)
#   - Zellij is available for session management
#   - /workspace/ mount point exists
#   - User 'sandbox' can execute commands
#
# WHAT THIS TEST DOES NOT VALIDATE (use full VM for these):
#   - Nested virtualization (KVM passthrough)
#   - Host-initiated git sync
#   - Development server proxy
#   - Zellij web server
#
# ARCHITECTURE:
#   Host: MicroVM Runner (QEMU direct kernel boot)
#         └── NixOS Guest (Agent Sandbox)
#             ├── sandbox user
#             ├── Development tools
#             ├── Zellij
#             └── /workspace/ mount point
#
# RELATED FILES:
#   - tests/microvm/agent-sandbox.nix  - MicroVM guest configuration
#   - tests/flake.nix                  - Flake with microvm input
#   - modules/keystone/agent/guest/    - Guest configuration modules
#   - specs/012-agent-sandbox/spec.md  - Functional requirements
#
# USAGE:
#   ./bin/test-microvm-agent
#   # Automatically enters nix develop shell if needed
#
# =============================================================================
set -euo pipefail

SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
PROJECT_ROOT=$(dirname "$SCRIPT_DIR")

# Re-exec in nix develop if not already in nix shell
if [ -z "${IN_NIX_SHELL:-}" ]; then
    echo "Entering nix develop shell..."
    exec nix develop "$PROJECT_ROOT" --command "$0" "$@"
fi

MICROVM_LOG="$PROJECT_ROOT/microvm-agent.log"
MICROVM_RUNNER="$PROJECT_ROOT/microvm-agent-runner"
WORKSPACE_DIR="$PROJECT_ROOT/tmp-workspace"

cleanup() {
  echo "Cleaning up..."
  rm -rf "$WORKSPACE_DIR"
  rm -rf "$MICROVM_RUNNER"
  echo "Logs available at: $MICROVM_LOG"
}
trap cleanup EXIT

# Create temporary workspace directory for virtiofs mount
mkdir -p "$WORKSPACE_DIR"
echo "Created temporary workspace at: $WORKSPACE_DIR"

# Create a test file in workspace
echo "This is a test workspace" > "$WORKSPACE_DIR/README.md"

echo "Building MicroVM runner..."
nix build "$PROJECT_ROOT/tests#nixosConfigurations.agent-sandbox-microvm.config.microvm.declaredRunner" -o "$MICROVM_RUNNER"

echo "--- Running Agent Sandbox Test (single boot) ---"
# Set MICROVM_WORKSPACE_PATH for virtiofs mount
export MICROVM_WORKSPACE_PATH="$WORKSPACE_DIR"

# Run from project root so paths resolve correctly
cd "$PROJECT_ROOT"

# Run the MicroVM and capture output
if ! timeout 60 "$MICROVM_RUNNER/bin/microvm-run" > "$MICROVM_LOG" 2>&1; then
  echo "MicroVM test timed out or failed!"
  echo "Last 30 lines of MicroVM log:"
  tail -n 30 "$MICROVM_LOG"
  exit 1
fi

# Check for test success marker
if ! grep -q -- "--- Agent Sandbox Test: PASSED ---" "$MICROVM_LOG"; then
  echo "Agent Sandbox Test failed. Check logs."
  echo "Last 40 lines of MicroVM log:"
  tail -n 40 "$MICROVM_LOG"
  exit 1
fi

echo "MicroVM Agent Sandbox Test PASSED!"
