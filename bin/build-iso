#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
SSH_KEYS_FILE=""
OUTPUT_DIR="result"
SHOW_HELP=false

# Help function
show_help() {
    cat << EOF
Keystone ISO Builder

Usage: $0 [OPTIONS]

OPTIONS:
    -k, --ssh-keys FILE     File containing SSH public keys (one per line)
    -o, --output DIR        Output directory (default: result)
    -h, --help              Show this help message

EXAMPLES:
    # Build ISO without SSH keys
    $0

    # Build ISO with SSH keys from file
    $0 --ssh-keys ~/.ssh/authorized_keys

    # Build with custom output directory
    $0 --ssh-keys keys.txt --output my-iso

SSH KEYS FILE FORMAT:
    The SSH keys file should contain one public key per line, for example:
    
    ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG... user@workstation
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQD... admin@server

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -k|--ssh-keys)
            SSH_KEYS_FILE="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        -h|--help)
            SHOW_HELP=true
            shift
            ;;
        *)
            echo -e "${RED}Error: Unknown option $1${NC}" >&2
            show_help
            exit 1
            ;;
    esac
done

if [[ "$SHOW_HELP" == "true" ]]; then
    show_help
    exit 0
fi

# Validate SSH keys file if provided
if [[ -n "$SSH_KEYS_FILE" ]]; then
    if [[ ! -f "$SSH_KEYS_FILE" ]]; then
        echo -e "${RED}Error: SSH keys file '$SSH_KEYS_FILE' not found${NC}" >&2
        exit 1
    fi
    
    # Check if file has valid SSH keys
    if ! grep -q "^ssh-" "$SSH_KEYS_FILE"; then
        echo -e "${YELLOW}Warning: No SSH keys found in '$SSH_KEYS_FILE'${NC}" >&2
        echo -e "${YELLOW}Expected format: one SSH public key per line${NC}" >&2
    fi
fi

echo -e "${BLUE}ðŸ”¨ Building Keystone ISO...${NC}"

# Create temporary flake if SSH keys are provided
if [[ -n "$SSH_KEYS_FILE" ]]; then
    echo -e "${BLUE}ðŸ“‹ Using SSH keys from: $SSH_KEYS_FILE${NC}"
    
    # Create temporary directory
    TEMP_DIR=$(mktemp -d)
    trap "rm -rf $TEMP_DIR" EXIT
    
    # Read SSH keys into array format for Nix
    echo -e "${BLUE}ðŸ”‘ Processing SSH keys...${NC}"
    SSH_KEYS_ARRAY="["
    while IFS= read -r line; do
        # Skip empty lines and comments
        if [[ -n "$line" && ! "$line" =~ ^[[:space:]]*# ]]; then
            # Escape quotes and add to array
            ESCAPED_KEY=$(echo "$line" | sed 's/"/\\"/g')
            SSH_KEYS_ARRAY="$SSH_KEYS_ARRAY\"$ESCAPED_KEY\" "
        fi
    done < "$SSH_KEYS_FILE"
    SSH_KEYS_ARRAY="$SSH_KEYS_ARRAY]"
    
    # Create temporary flake
    cat > "$TEMP_DIR/flake.nix" << EOF
{
  description = "Keystone ISO with custom SSH keys";
  
  inputs = {
    keystone.url = "path:$(pwd)";
    nixpkgs.follows = "keystone/nixpkgs";
  };
  
  outputs = { self, keystone, nixpkgs }: {
    nixosConfigurations = {
      keystoneIso = keystone.lib.mkKeystoneIso {
        sshKeys = $SSH_KEYS_ARRAY;
      };
    };
    
    packages.x86_64-linux.default = 
      self.nixosConfigurations.keystoneIso.config.system.build.isoImage;
  };
}
EOF
    
    echo -e "${BLUE}ðŸš€ Building ISO with SSH keys...${NC}"
    cd "$TEMP_DIR"
    nix build --out-link "../$OUTPUT_DIR"
    cd - > /dev/null
    
else
    echo -e "${BLUE}ðŸš€ Building ISO without SSH keys...${NC}"
    nix build ".#nixosConfigurations.keystoneIso.config.system.build.isoImage" --out-link "$OUTPUT_DIR"
fi

# Check if build was successful
if [[ -L "$OUTPUT_DIR" && -d "$OUTPUT_DIR" ]]; then
    # Look for any ISO file in the result directory tree
    # Using ls instead of find due to Nix store filesystem quirks
    ISO_PATH=$(ls "$OUTPUT_DIR"/iso/*.iso 2>/dev/null | head -1)
    if [[ -n "$ISO_PATH" && -f "$ISO_PATH" ]]; then
        ISO_SIZE=$(du -h "$ISO_PATH" | cut -f1)
        ISO_NAME=$(basename "$ISO_PATH")
        echo -e "${GREEN}âœ… ISO built successfully!${NC}"
        echo -e "${GREEN}ðŸ“ Location: $ISO_PATH${NC}"
        echo -e "${GREEN}ðŸ“„ Filename: $ISO_NAME${NC}"
        echo -e "${GREEN}ðŸ“¦ Size: $ISO_SIZE${NC}"
        echo ""
        echo -e "${BLUE}ðŸ”¥ To write to USB:${NC}"
        echo -e "${BLUE}   sudo dd if=\"$ISO_PATH\" of=/dev/sdX bs=4M status=progress${NC}"
        echo -e "${YELLOW}   (Replace /dev/sdX with your USB device)${NC}"
    else
        echo -e "${RED}âŒ Build completed but ISO file not found${NC}" >&2
        echo -e "${YELLOW}Contents of $OUTPUT_DIR:${NC}" >&2
        find "$OUTPUT_DIR" -type f >&2
        exit 1
    fi
else
    echo -e "${RED}âŒ Build failed - $OUTPUT_DIR does not exist or is not a symlink${NC}" >&2
    exit 1
fi