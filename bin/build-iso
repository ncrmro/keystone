#!/usr/bin/env bash
#
# Keystone ISO Builder
#
# NOTE: This script is part of the automated testing procedure.
#       Any changes here should be reflected in docs/testing-procedure.md
#
# See: docs/testing-procedure.md for complete testing workflows

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
SSH_KEYS_INPUT=""
NO_SSH_KEYS=false
OUTPUT_DIR="result"
ARCH="x86_64-linux"
SHOW_HELP=false

# Help function
show_help() {
    cat << EOF
Keystone ISO Builder

Usage: $0 [OPTIONS]

OPTIONS:
    -k, --ssh-key INPUT     SSH public key as file path or key string directly
    --no-ssh-key            Build ISO without SSH keys (âš ï¸  creates inaccessible installer)
    -a, --arch ARCH         Target architecture: x86_64-linux or aarch64-linux (default: x86_64-linux)
    -o, --output DIR        Output directory (default: result)
    -h, --help              Show this help message

NOTE: Either --ssh-key or --no-ssh-key MUST be specified.

ARCHITECTURE NOTES:
    x86_64-linux   Standard PC/server ISO with ZFS support
    aarch64-linux  Apple Silicon ISO using nixos-apple-silicon (Asahi kernel, no ZFS)

EXAMPLES:
    # Build x86_64 ISO with SSH key from file
    $0 --ssh-key ~/.ssh/id_ed25519.pub
    $0 --ssh-key /home/user/.ssh/authorized_keys

    # Build ISO with SSH key string directly
    $0 --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG... user@host"

    # Build with custom output directory
    $0 --ssh-key ~/.ssh/id_ed25519.pub --output my-iso

    # Build for Apple Silicon Macs (uses Asahi Linux kernel)
    $0 --ssh-key ~/.ssh/id_ed25519.pub --arch aarch64-linux

    # Build ISO without SSH keys (âš ï¸  creates inaccessible installer - only for testing)
    $0 --no-ssh-key

SSH KEY INPUT:
    Can be either:
    - File path (starts with /, ~, or .): File containing SSH public keys (one per line)
    - Key string: SSH public key string directly
    
    Examples:
    - ~/.ssh/id_ed25519.pub                              (file path)
    - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG... user@host  (key string)

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -k|--ssh-key)
            SSH_KEYS_INPUT="$2"
            shift 2
            ;;
        --no-ssh-key)
            NO_SSH_KEYS=true
            shift
            ;;
        -a|--arch)
            ARCH="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        -h|--help)
            SHOW_HELP=true
            shift
            ;;
        *)
            echo -e "${RED}Error: Unknown option $1${NC}" >&2
            show_help
            exit 1
            ;;
    esac
done

if [[ "$SHOW_HELP" == "true" ]]; then
    show_help
    exit 0
fi

# Validate that either --ssh-key or --no-ssh-key is specified
if [[ -n "$SSH_KEYS_INPUT" && "$NO_SSH_KEYS" == "true" ]]; then
    echo -e "${RED}Error: Cannot specify both --ssh-key and --no-ssh-key${NC}" >&2
    echo -e "${YELLOW}Use --ssh-key to include SSH keys, or --no-ssh-key to build without them${NC}" >&2
    exit 1
fi

if [[ -z "$SSH_KEYS_INPUT" && "$NO_SSH_KEYS" == "false" ]]; then
    echo -e "${RED}Error: Either --ssh-key or --no-ssh-key must be specified${NC}" >&2
    echo -e "${YELLOW}Building without SSH keys creates an inaccessible installer!${NC}" >&2
    echo "" >&2
    echo -e "Examples:" >&2
    echo -e "  ${BLUE}$0 --ssh-key ~/.ssh/id_ed25519.pub${NC}   # Recommended" >&2
    echo -e "  ${BLUE}$0 --no-ssh-key${NC}                     # Only for testing" >&2
    exit 1
fi

# Validate architecture
if [[ "$ARCH" != "x86_64-linux" && "$ARCH" != "aarch64-linux" ]]; then
    echo -e "${RED}Error: Invalid architecture '$ARCH'${NC}" >&2
    echo -e "${YELLOW}Valid options: x86_64-linux, aarch64-linux${NC}" >&2
    exit 1
fi

# Check for cross-compilation capability
HOST_ARCH=$(uname -m)
if [[ "$ARCH" == "aarch64-linux" && "$HOST_ARCH" == "x86_64" ]]; then
    # Check if binfmt emulation is available
    if [[ -f /proc/sys/fs/binfmt_misc/qemu-aarch64 ]]; then
        echo -e "${BLUE}â„¹ï¸  Cross-compiling aarch64-linux on x86_64 (using binfmt emulation)${NC}"
    elif nix show-config 2>/dev/null | grep -q "aarch64-linux"; then
        echo -e "${BLUE}â„¹ï¸  Cross-compiling aarch64-linux on x86_64 (using remote builder)${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Cross-compiling aarch64-linux on x86_64${NC}" >&2
        echo -e "${YELLOW}   No binfmt emulation or remote builder detected.${NC}" >&2
        echo -e "${YELLOW}   Build may fail or be slow. To enable fast cross-compilation:${NC}" >&2
        echo "" >&2
        echo -e "${BLUE}   # Add to your NixOS configuration:${NC}" >&2
        echo -e "${BLUE}   boot.binfmt.emulatedSystems = [ \"aarch64-linux\" ];${NC}" >&2
        echo "" >&2
        echo -e "${YELLOW}   Then rebuild: sudo nixos-rebuild switch${NC}" >&2
        echo "" >&2
        read -p "Continue anyway? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
elif [[ "$ARCH" == "x86_64-linux" && "$HOST_ARCH" == "aarch64" ]]; then
    if [[ -f /proc/sys/fs/binfmt_misc/qemu-x86_64 ]]; then
        echo -e "${BLUE}â„¹ï¸  Cross-compiling x86_64-linux on aarch64 (using binfmt emulation)${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Cross-compiling x86_64-linux on aarch64 - may require remote builder${NC}" >&2
    fi
fi

# Warn if building without SSH keys
if [[ "$NO_SSH_KEYS" == "true" ]]; then
    echo -e "${YELLOW}âš ï¸  Building ISO without SSH keys - this will create an inaccessible installer!${NC}" >&2
    echo -e "${YELLOW}âš ï¸  This is only recommended for testing purposes.${NC}" >&2
    echo "" >&2
fi

# Process SSH keys input if provided
SSH_KEYS_FILE=""
if [[ -n "$SSH_KEYS_INPUT" ]]; then
    # Check if input looks like a file path (starts with /, ~, or .)
    if [[ "$SSH_KEYS_INPUT" =~ ^[/~.] ]]; then
        # Treat as file path
        SSH_KEYS_FILE="$SSH_KEYS_INPUT"
        
        if [[ ! -f "$SSH_KEYS_FILE" ]]; then
            echo -e "${RED}Error: SSH keys file '$SSH_KEYS_FILE' not found${NC}" >&2
            exit 1
        fi
        
        # Check if file has valid SSH keys
        if ! grep -q "^ssh-" "$SSH_KEYS_FILE"; then
            echo -e "${YELLOW}Warning: No SSH keys found in '$SSH_KEYS_FILE'${NC}" >&2
            echo -e "${YELLOW}Expected format: one SSH public key per line${NC}" >&2
        fi
    else
        # Treat as direct SSH key string
        if [[ ! "$SSH_KEYS_INPUT" =~ ^ssh- ]]; then
            echo -e "${RED}Error: SSH key string must start with 'ssh-'${NC}" >&2
            echo -e "${YELLOW}Example: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG... user@host${NC}" >&2
            exit 1
        fi
        
        # Create temporary file with the SSH key
        SSH_KEYS_FILE=$(mktemp)
        echo "$SSH_KEYS_INPUT" > "$SSH_KEYS_FILE"
        
        # Clean up temp file on exit
        trap "rm -f $SSH_KEYS_FILE" EXIT
    fi
fi

echo -e "${BLUE}ðŸ”¨ Building Keystone ISO...${NC}"

# Create temporary flake if SSH keys are provided
if [[ -n "$SSH_KEYS_FILE" ]]; then
    echo -e "${BLUE}ðŸ“‹ Using SSH keys from: $SSH_KEYS_FILE${NC}"
    
    # Store original working directory
    ORIG_DIR=$(pwd)
    
    # Create temporary directory
    TEMP_DIR=$(mktemp -d)
    trap "rm -rf $TEMP_DIR" EXIT
    
    # Read SSH keys into array format for Nix
    echo -e "${BLUE}ðŸ”‘ Processing SSH keys...${NC}"
    SSH_KEYS_ARRAY="["
    while IFS= read -r line; do
        # Skip empty lines and comments
        if [[ -n "$line" && ! "$line" =~ ^[[:space:]]*# ]]; then
            # Escape quotes and add to array
            ESCAPED_KEY=$(echo "$line" | sed 's/"/\\"/g')
            SSH_KEYS_ARRAY="$SSH_KEYS_ARRAY\"$ESCAPED_KEY\" "
        fi
    done < "$SSH_KEYS_FILE"
    SSH_KEYS_ARRAY="$SSH_KEYS_ARRAY]"
    
    # Create temporary flake (architecture-specific)
    if [[ "$ARCH" == "aarch64-linux" ]]; then
        # Apple Silicon: use nixos-apple-silicon module
        cat > "$TEMP_DIR/flake.nix" << EOF
{
  description = "Keystone ISO with custom SSH keys (Apple Silicon)";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    nixos-apple-silicon = {
      url = "github:tpwrules/nixos-apple-silicon";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, nixos-apple-silicon }: {
    nixosConfigurations = {
      keystoneIso = nixpkgs.lib.nixosSystem {
        system = "aarch64-linux";
        modules = [
          "\${nixpkgs}/nixos/modules/installer/cd-dvd/installation-cd-minimal.nix"
          nixos-apple-silicon.nixosModules.apple-silicon-support
          $(pwd)/modules/iso-installer-apple-silicon.nix
          {
            _module.args.sshKeys = $SSH_KEYS_ARRAY;
            _module.args.enableTui = true;
          }
        ];
      };
    };

    packages.aarch64-linux.default =
      self.nixosConfigurations.keystoneIso.config.system.build.isoImage;
  };
}
EOF
    else
        # x86_64: use standard kernel
        cat > "$TEMP_DIR/flake.nix" << EOF
{
  description = "Keystone ISO with custom SSH keys";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.05";
  };

  outputs = { self, nixpkgs }: {
    nixosConfigurations = {
      keystoneIso = nixpkgs.lib.nixosSystem {
        system = "$ARCH";
        modules = [
          "\${nixpkgs}/nixos/modules/installer/cd-dvd/installation-cd-minimal.nix"
          $(pwd)/modules/iso-installer.nix
          {
            _module.args.sshKeys = $SSH_KEYS_ARRAY;
            _module.args.enableTui = true;
            boot.kernelPackages = nixpkgs.lib.mkForce
              nixpkgs.legacyPackages.$ARCH.linuxPackages_6_12;
          }
        ];
      };
    };

    packages.$ARCH.default =
      self.nixosConfigurations.keystoneIso.config.system.build.isoImage;
  };
}
EOF
    fi

    echo -e "${BLUE}ðŸš€ Building $ARCH ISO with SSH keys...${NC}"
    cd "$TEMP_DIR"
    nix build ".#packages.${ARCH}.default" --impure --out-link "$ORIG_DIR/$OUTPUT_DIR"
    cd - > /dev/null
    
else
    # For x86_64-linux without SSH keys, use the main flake
    # For aarch64-linux, we need a temporary flake
    if [[ "$ARCH" == "x86_64-linux" ]]; then
        echo -e "${BLUE}ðŸš€ Building $ARCH ISO without SSH keys...${NC}"
        nix build ".#iso" --out-link "$OUTPUT_DIR"
    else
        # aarch64-linux without SSH keys: use Apple Silicon support
        echo -e "${BLUE}ðŸš€ Building $ARCH ISO without SSH keys (Apple Silicon)...${NC}"

        ORIG_DIR=$(pwd)
        TEMP_DIR=$(mktemp -d)
        trap "rm -rf $TEMP_DIR" EXIT

        cat > "$TEMP_DIR/flake.nix" << EOF
{
  description = "Keystone ISO for Apple Silicon";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    nixos-apple-silicon = {
      url = "github:tpwrules/nixos-apple-silicon";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, nixos-apple-silicon }: {
    nixosConfigurations = {
      keystoneIso = nixpkgs.lib.nixosSystem {
        system = "aarch64-linux";
        modules = [
          "\${nixpkgs}/nixos/modules/installer/cd-dvd/installation-cd-minimal.nix"
          nixos-apple-silicon.nixosModules.apple-silicon-support
          $(pwd)/modules/iso-installer-apple-silicon.nix
          {
            _module.args.sshKeys = [];
            _module.args.enableTui = true;
          }
        ];
      };
    };

    packages.aarch64-linux.default =
      self.nixosConfigurations.keystoneIso.config.system.build.isoImage;
  };
}
EOF

        cd "$TEMP_DIR"
        nix build ".#packages.${ARCH}.default" --impure --out-link "$ORIG_DIR/$OUTPUT_DIR"
        cd - > /dev/null
    fi
fi

# Check if build was successful
if [[ -L "$OUTPUT_DIR" && -d "$OUTPUT_DIR" ]]; then
    # Look for any ISO file in the result directory tree
    # Using ls instead of find due to Nix store filesystem quirks
    ISO_PATH=$(ls "$OUTPUT_DIR"/iso/*.iso 2>/dev/null | head -1)
    if [[ -n "$ISO_PATH" && -f "$ISO_PATH" ]]; then
        ISO_SIZE=$(du -h "$ISO_PATH" | cut -f1)
        ISO_NAME=$(basename "$ISO_PATH")
        echo -e "${GREEN}âœ… ISO built successfully!${NC}"
        echo -e "${GREEN}ðŸ“ Location: $ISO_PATH${NC}"
        echo -e "${GREEN}ðŸ“„ Filename: $ISO_NAME${NC}"
        echo -e "${GREEN}ðŸ“¦ Size: $ISO_SIZE${NC}"

        # Link ISO to vms directory for VM testing
        VM_ISO_PATH="vms/keystone-installer.iso"
        if [[ -e "$VM_ISO_PATH" ]]; then
            rm -f "$VM_ISO_PATH"
        fi
        ln -sf "../$ISO_PATH" "$VM_ISO_PATH"
        echo -e "${GREEN}ðŸ”— Linked to: $VM_ISO_PATH${NC}"

        echo ""
        echo -e "${BLUE}ðŸ”¥ To write to USB:${NC}"
        echo -e "${BLUE}   sudo dd if=\"$ISO_PATH\" of=/dev/sdX bs=4M status=progress${NC}"
        echo -e "${YELLOW}   (Replace /dev/sdX with your USB device)${NC}"
    else
        echo -e "${RED}âŒ Build completed but ISO file not found${NC}" >&2
        echo -e "${YELLOW}Contents of $OUTPUT_DIR:${NC}" >&2
        find "$OUTPUT_DIR" -type f >&2
        exit 1
    fi
else
    echo -e "${RED}âŒ Build failed - $OUTPUT_DIR does not exist or is not a symlink${NC}" >&2
    exit 1
fi